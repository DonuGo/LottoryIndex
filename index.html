<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<style>
.number input[type="checkbox"] {
	display: none;
}
.number input[type="checkbox"] + label {
	display: inline-block;
	background-color: #FFF;
	cursor: pointer;
	padding: 5px 10px;
	border:1px solid #000;
}
.number input[type="checkbox"]:checked + label {
	background-color: #8ff;
}
	</style>
	
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
	<script src="https://cdn.rawgit.com/ethereumjs/browser-builds/2fb69a714afe092b06645286f14b94f41e5c062c/dist/ethereumjs-tx.js"></script>
	<script>
	
	let Web3 = require('web3');
	let web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io/f8f78ce5057748059abbd716d80c7692"));
	let privateKey = [ new EthJS.Buffer.Buffer('8053DC015C44B5262A4D42F0D62C5531B2C1E89B4839A8CD581EAF256B586C08', 'hex'), 
		new EthJS.Buffer.Buffer('0DC323696438A754D669665F06CABC9CC4F30DACE0DF48BCE307DEE73043907E', 'hex'), 
		new EthJS.Buffer.Buffer('4A8CF2C8BA765087F870124CBAF61C71063BAA84AFD6C366C3143B579C9AF489', 'hex'), 
		new EthJS.Buffer.Buffer('13C808002F81008293FF351832ED7FF4662FAEAF9EBE508B4CD5CA30D522FE67', 'hex'), 
		new EthJS.Buffer.Buffer('4B15596FFFF5C98CB4886687AE214E43DC256993F2BA9755880FE6732AA9C52A', 'hex')
	];
	let accountAddress = ["0x5e8f5db76176a35a88a32684590793154625250b",
	"0xd22cee2348cd21ba67840306a20312b99e0a02ec",
	"0xba5fb4b844b2db5dd7119ddec1bbc879859abc5a",
	"0x9241ddbb4b832580f1e104dc294afae98bc3ac0d",
	"0x1b939c85a1dba97252109ddcbb13ab48330142ec"];
	
	let contractAddress = "0xb438f13542cc0fe1c7c710ab28fce969a90bf8c5";

function Winning() {
	
	let non = web3.eth.getTransactionCount(accountAddress[0]);  
	console.log(non);
	let sayHello = "0x" + web3.sha3("winning()").substr(2,8);
	let txParams = {
		nonce: non,
		to: contractAddress, 
		gasPrice: '0x09184e72a0',
		gasLimit: '0x271000',
		data: sayHello,
	}
	let tx = new EthJS.Tx(txParams)
	tx.sign(privateKey[0])
	let serializedTx = tx.serialize().toString('hex')

	web3.eth.sendRawTransaction('0x' + serializedTx.toString('hex'), function(err, hash) {
		if (!err) {
			console.log(hash); // "0x7f9fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385"
			console.log(web3.eth.getTransaction(hash));
		}
		else 
			console.log(err); 
	});
	console.log("Reset");
}
function Reset() {
	let non = web3.eth.getTransactionCount(accountAddress[0]);  
		console.log(non);
		let sayHello = "0x" + web3.sha3("resetState()").substr(2,8);
		let txParams = {
			nonce: non,
			to: contractAddress, 
			gasPrice: '0x09184e72a0',
			gasLimit: '0x271000',
			data: sayHello,
		}
		let tx = new EthJS.Tx(txParams)
		tx.sign(privateKey[0])
		let serializedTx = tx.serialize().toString('hex')
	
		web3.eth.sendRawTransaction('0x' + serializedTx.toString('hex'), function(err, hash) {
			if (!err) 
				console.log(hash); // "0x7f9fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385"
			else 
				console.log(err); 
		});
	console.log("Reset");
}
function Betting(phone, num1, num2) {
	let r = Math.floor((Math.random() * 4));
	let non = web3.eth.getTransactionCount(accountAddress[r]);
	
	let phonestring = phone.toString('hex');
	while (phonestring.length < 64) {phonestring = "0" + phonestring;}
	//console.log("phonestring:", phonestring)
	
	let numstring1 = num1.toString('hex') + num2.toString('hex');
	while (numstring1.length < 64) {numstring1 = "0" + numstring1;}
	//console.log("numstring1:", numstring1)
	
	let sayHello = "0x" + web3.sha3("betting(uint256,uint256)").substr(2,8) + phonestring + numstring1;
	// console.log(sayHello);
	
	let txParams = {
		nonce:    non,
		to: contractAddress, 
		gasPrice: '0x19184e72a0',
		gasLimit: '0x271000',
		data: sayHello,
	}
	let tx = new EthJS.Tx(txParams)
	tx.sign(privateKey[r])
	let serializedTx = tx.serialize().toString('hex')

	web3.eth.sendRawTransaction('0x' + serializedTx.toString('hex'), function(err, hash) {
		if (!err) {
			console.log(hash); // "0x7f9fade1c0d57a7af66ab4ead79fade1c0d57a7af66ab4ead7c2c2eb7b11a91385"
			document.getElementById("p1").innerHTML = "您的分機號碼為: " + phone;
			document.getElementById("p2").innerHTML = "您已成功投注: " + num1 + ", " + num2;

		} else
			console.log(err); 
	});
	console.log("Set");
}

function getWinner() {
	let functionSig = "0x" + web3.sha3("getWinner()").substr(2,8);
	let result = web3.eth.call({
		// contract address
		to: contractAddress,
		// contract function from sha3 "()"
		data: functionSig
	});
	let count = parseInt("0x" + (result.substr(result.length - 2,2))) ;
	console.log(result);
	for (let i = 0; i < count; i++) {
		console.log((result.substr(2 + 64 * i, 64)));
	}
	for (let i = 0; i < count; i++) {
		console.log((result.substr(2 + 100 * 64 + 64 * i, 64)));
	}
}
function getBettor() {
	let functionSig = "0x" + web3.sha3("getBettor()").substr(2,8);
	let result = web3.eth.call({
		// contract address
		to: contractAddress,
		// contract function from sha3 "()"
		data: functionSig
	});
	let count = parseInt("0x" + (result.substr(result.length - 2,2))) ;
	console.log(count);
	for (let i = 0; i < count; i++) {
		console.log((result.substr(2 + 64 * i, 64)));
	}
	for (let i = 0; i < count; i++) {
		console.log((result.substr(2 + 100 * 64 + 64 * i, 64)));
	}
}

function KeepCount() {
	let elements = document.getElementsByName("skill");
	let total = 0;

	for(let i in elements) {
		let element = elements[i];
		if(element.checked) {
			total++;
		}
		if(total > 2) {
			alert("Two numbers are required");
			element.checked = false;
			return false;
		}

	}
}
function bet() {

	let phonenumber = document.getElementById("phone");
	let elements = document.getElementsByName("skill");
	let total = 0;
	console.log(phonenumber.value);
	if (phonenumber.value == "") {
		alert("Please enter your phone number");
		return false;
	}
	
	let number1 = elements[0].id;
	let number2 = elements[0].id;
	
	for(let i in elements) {
		let element = elements[i];
		if(element.checked) {
			total++;
			if(total==1) number1 = element.id;
			else if (total==2) number2 = element.id;			
		}
	}
	
	if(total != 2) {
		alert("Please choose two numbers");
		return false;
	}

	document.cookie = "played=yes";
	if (document.cookie.split(';').filter((item) => item.includes('played=')).length) {
		console.log('exists')
	} else {
		console.log('not exists')
	}
			
	Betting(phonenumber.value, number1, number2);

}
	</script>
	

</head>
<body>
	<h1>威盛大區塊鏈樂透系統</h1>
	<h3>請輸入您的分機號碼</h3>
	<input type="text" id="phone" name="phoneNumber"><br>
	<h3>請圈選兩個號碼</h3>
	<div class="number">
		<input type="checkbox" id="1" name="skill" onclick="return KeepCount()">
		<label for="1">1</label>

		<input type="checkbox" id="2" name="skill" onclick="return KeepCount()">
		<label for="2">2</label>

		<input type="checkbox" id="3" name="skill" onclick="return KeepCount()">
		<label for="3">3</label>

		<input type="checkbox" id="4" name="skill" onclick="return KeepCount()">
		<label for="4">4</label>

		<input type="checkbox" id="5" name="skill" onclick="return KeepCount()">
		<label for="5">5</label>

		<input type="checkbox" id="6" name="skill" onclick="return KeepCount()">
		<label for="6">6</label>

		<input type="checkbox" id="7" name="skill" onclick="return KeepCount()">
		<label for="7">7</label>

		<input type="checkbox" id="8" name="skill" onclick="return KeepCount()">
		<label for="8">8</label>

		<input type="checkbox" id="9" name="skill" onclick="return KeepCount()">
		<label for="9">9</label>
	</div>
	<br>
	<button onclick="return bet()">投注</button>
	<!--
	<h3>投注者</h3>
	<button onclick="return getBettor()">Get Bettor</button>
	<h3>樂透開獎</h3>
	<button onclick="return Winning()">Winning</button>
	<h3>中獎者</h3>
	<button onclick="return getWinner()">Get Winner</button>
	<h3>重設</h3>
	<button onclick="return Reset()">Reset</button>
	-->
	<p id="p1"></p>
	<p id="p2"></p>
</body></html>
